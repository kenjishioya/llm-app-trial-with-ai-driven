name: ðŸ›¡ï¸ Security Scan Pipeline

on:
  schedule:
    # æ¯Žæ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 17 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  dependency-scan:
    name: ðŸ“¦ Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Python security tools
        run: |
          pip install pip-audit safety bandit

      - name: Python dependency scan
        run: |
          echo "ðŸ” Pythonä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³"
          cd backend
          pip-audit --desc --format=json --output=python-vulns.json
          echo "âœ… Python ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

      - name: Python SAST scan
        run: |
          echo "ðŸ” Python SAST ã‚¹ã‚­ãƒ£ãƒ³"
          cd backend
          bandit -r . -f json -o bandit-report.json -ll
          echo "âœ… Python SASTå®Œäº†"

      - name: Node.js dependency scan
        run: |
          echo "ðŸ” Node.jsä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³"
          cd frontend
          npm install
          npm audit --audit-level=high --json > npm-audit.json || true
          echo "âœ… Node.js ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}
          path: |
            backend/python-vulns.json
            backend/bandit-report.json
            frontend/npm-audit.json
          retention-days: 90

  secrets-scan:
    name: ðŸ” Secrets Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install detect-secrets
        run: |
          pip install detect-secrets

      - name: Run secrets scan
        run: |
          echo "ðŸ” æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"
          detect-secrets scan --baseline .secrets.baseline --force-use-all-plugins
          echo "âœ… æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

      - name: Generate new baseline (if needed)
        run: |
          detect-secrets scan --update .secrets.baseline --force-use-all-plugins

  license-compliance:
    name: ðŸ“„ License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install license checker
        run: |
          pip install pip-licenses

      - name: Check Python licenses
        run: |
          echo "ðŸ“„ Python ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç¢ºèª"
          cd backend
          pip install -r requirements.txt
          pip-licenses --format=json --output-file=python-licenses.json
          echo "âœ… Python ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç¢ºèªå®Œäº†"

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports-${{ github.run_id }}
          path: |
            backend/python-licenses.json
          retention-days: 30

  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, secrets-scan, license-compliance]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate security summary
        run: |
          echo "# ðŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœã‚µãƒžãƒªãƒ¼" >> security-summary.md
          echo "## å®Ÿè¡Œæ—¥æ™‚: $(date)" >> security-summary.md
          echo "" >> security-summary.md

          echo "## ðŸ“Š çµæžœä¸€è¦§" >> security-summary.md
          echo "- ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.dependency-scan.result }}" >> security-summary.md
          echo "- æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.secrets-scan.result }}" >> security-summary.md
          echo "- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç¢ºèª: ${{ needs.license-compliance.result }}" >> security-summary.md
          echo "" >> security-summary.md

          if [[ "${{ needs.dependency-scan.result }}" == "success" &&
                "${{ needs.secrets-scan.result }}" == "success" &&
                "${{ needs.license-compliance.result }}" == "success" ]]; then
            echo "âœ… **ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ**" >> security-summary.md
          else
            echo "âŒ **ä¸€éƒ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**" >> security-summary.md
            echo "" >> security-summary.md
            echo "è©³ç´°ã¯Artifactsã®ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> security-summary.md
          fi

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary-${{ github.run_id }}
          path: security-summary.md
          retention-days: 90
