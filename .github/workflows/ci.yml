name: ğŸ§ª Application CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore: ['infra/**', 'docs/**', '*.md']
  pull_request:
    branches: [main]
    paths-ignore: ['infra/**', 'docs/**', '*.md']

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  # Phase 0: åŸºç›¤æ¤œè¨¼ã®ã¿
  validate-structure:
    name: ğŸ“‹ Phase 0 - Project Structure Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate project structure
        run: |
          echo "ğŸ” Phase 0 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ æ¤œè¨¼"

          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo "ğŸ“ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          test -f docker-compose.yml && echo "âœ… docker-compose.yml"
          test -f docker-compose.test.yml && echo "âœ… docker-compose.test.yml"
          test -f .pre-commit-config.yaml && echo "âœ… .pre-commit-config.yaml"
          test -f .secrets.baseline && echo "âœ… .secrets.baseline"
          test -f backend/scripts/init.sql && echo "âœ… backend/scripts/init.sql"

          echo "âœ… Phase 0 æ§‹é€ æ¤œè¨¼å®Œäº†"

  docker-validation:
    name: ğŸ³ Docker Environment Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Docker Compose configuration
        run: |
          echo "ğŸ³ Docker Composeè¨­å®šæ¤œè¨¼"

          # Compose ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡æ³•ãƒã‚§ãƒƒã‚¯
          docker compose -f docker-compose.yml config > /dev/null
          echo "âœ… docker-compose.yml æ–‡æ³•OK"

          docker compose -f docker-compose.test.yml config > /dev/null
          echo "âœ… docker-compose.test.yml æ–‡æ³•OK"

          echo "âœ… Dockerè¨­å®šæ¤œè¨¼å®Œäº†"

  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install detect-secrets
        run: |
          pip install detect-secrets

      - name: Run secrets detection
        run: |
          echo "ğŸ” æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"
          detect-secrets scan --baseline .secrets.baseline
          echo "âœ… æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

      - name: Validate pre-commit config
        run: |
          echo "ğŸ” pre-commitè¨­å®šæ¤œè¨¼"
          pip install pre-commit
          pre-commit validate-config
          echo "âœ… pre-commitè¨­å®šæ¤œè¨¼å®Œäº†"

  quality-gate:
    name: ğŸšª Quality Gate
    runs-on: ubuntu-latest
    needs: [validate-structure, docker-validation, security-scan]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "ğŸ“Š Phase 0 å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯"

          # å¿…é ˆã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          if [[ "${{ needs.validate-structure.result }}" != "success" ]]; then
            echo "âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ æ¤œè¨¼å¤±æ•—"
            exit 1
          fi

          if [[ "${{ needs.docker-validation.result }}" != "success" ]]; then
            echo "âŒ Dockerè¨­å®šæ¤œè¨¼å¤±æ•—"
            exit 1
          fi

          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—"
            exit 1
          fi

          echo "âœ… Phase 0 å“è³ªã‚²ãƒ¼ãƒˆé€šé"
          echo "ğŸ¯ Phase 1 é–‹ç™ºæº–å‚™å®Œäº†"
