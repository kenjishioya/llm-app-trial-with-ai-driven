name: ğŸ§ª QRAI CI/CD Pipeline - Phase 1.5 Production Ready

on:
  push:
    branches: [main, develop, feature/*]
    paths-ignore: ['infra/**', 'docs/**', '*.md']
  pull_request:
    branches: [main, develop]
    paths-ignore: ['infra/**', 'docs/**', '*.md']

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  POSTGRES_VERSION: '16'

jobs:
  # Phase 1: åŸºç›¤æ¤œè¨¼ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setup-validation:
    name: ğŸ—ï¸ Setup & Validation
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=deps-${{ hashFiles('backend/requirements.txt', 'frontend/package.json', 'frontend/pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT

      - name: Validate project structure
        run: |
          echo "ğŸ” Phase 1.5 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ æ¤œè¨¼"

          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo "ğŸ“ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          test -f docker-compose.yml && echo "âœ… docker-compose.yml"
          test -f docker-compose.test.yml && echo "âœ… docker-compose.test.yml"
          test -f .pre-commit-config.yaml && echo "âœ… .pre-commit-config.yaml"
          test -f .secrets.baseline && echo "âœ… .secrets.baseline"
          test -f backend/requirements.txt && echo "âœ… backend/requirements.txt"
          test -f backend/alembic.ini && echo "âœ… backend/alembic.ini"
          test -f frontend/package.json && echo "âœ… frontend/package.json"

          # Phase 1.5 å¿…é ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
          test -d backend/tests && echo "âœ… backend/tests/"
          test -d backend/migrations && echo "âœ… backend/migrations/"
          test -d scripts && echo "âœ… scripts/"

          echo "âœ… Phase 1.5 æ§‹é€ æ¤œè¨¼å®Œäº†"

  # Phase 2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: setup-validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install detect-secrets safety bandit pip-audit

      - name: Run secrets detection
        run: |
          echo "ğŸ” æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"
          python -m detect_secrets scan --baseline .secrets.baseline
          echo "âœ… æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

      - name: Run dependency vulnerability scan
        run: |
          echo "ğŸ” ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"
          cd backend
          pip-audit --desc --format=json --output=vulnerability-report.json || true
          if [ -f vulnerability-report.json ]; then
            echo "ğŸ“Š è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
          fi
          echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

      - name: Run SAST security scan
        run: |
          echo "ğŸ” SAST ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"
          cd backend
          bandit -r . -f json -o bandit-report.json -ll || true
          echo "âœ… SAST ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            backend/vulnerability-report.json
            backend/bandit-report.json
          retention-days: 30

  # Phase 3: Backend å“è³ªãƒ»ãƒ†ã‚¹ãƒˆ
  backend-quality:
    name: ğŸ Backend Quality & Testing
    runs-on: ubuntu-latest
    needs: setup-validation

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test_qrai
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password  # pragma: allowlist secret
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock

      - name: Run pre-commit hooks
        run: |
          pip install pre-commit
          pre-commit run --all-files

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql+asyncpg://test_user:test_password@localhost:5432/test_qrai  # pragma: allowlist secret
          ENVIRONMENT: test
        run: |
          cd backend
          echo "ğŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          pytest tests/unit/ -v --tb=short --cov=. --cov-report=xml --cov-report=html
          echo "âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql+asyncpg://test_user:test_password@localhost:5432/test_qrai  # pragma: allowlist secret
          ENVIRONMENT: test
        run: |
          cd backend
          echo "ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          pytest tests/integration/ -v --tb=short
          echo "âœ… çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-reports
          path: |
            backend/htmlcov/
            backend/coverage.xml
          retention-days: 30

  # Phase 4: Frontend å“è³ªãƒ»ãƒ“ãƒ«ãƒ‰
  frontend-quality:
    name: âš›ï¸ Frontend Quality & Build
    runs-on: ubuntu-latest
    needs: setup-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile

      - name: Run linting
        run: |
          cd frontend
          echo "ğŸ” ESLintå®Ÿè¡Œ"
          pnpm lint
          echo "âœ… ESLintå®Œäº†"

      - name: Run type checking
        run: |
          cd frontend
          echo "ğŸ” TypeScriptå‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
          pnpm type-check
          echo "âœ… TypeScriptå‹ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Run unit tests
        run: |
          cd frontend
          echo "ğŸ§ª ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          pnpm test:unit
          echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: Build application
        run: |
          cd frontend
          echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ"
          pnpm build
          echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 30

  # Phase 5: Docker çµ±åˆãƒ†ã‚¹ãƒˆ
  docker-integration:
    name: ğŸ³ Docker Integration Test
    runs-on: ubuntu-latest
    needs: [backend-quality, frontend-quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test Docker Compose configuration
        run: |
          echo "ğŸ” Docker Composeè¨­å®šæ¤œè¨¼"
          docker compose -f docker-compose.yml config > /dev/null
          docker compose -f docker-compose.test.yml config > /dev/null
          echo "âœ… Docker Composeè¨­å®šæ¤œè¨¼å®Œäº†"

      - name: Run integration tests with Docker
        run: |
          echo "ğŸ§ª Dockerçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit
          echo "âœ… Dockerçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: Cleanup Docker resources
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v --remove-orphans
          docker system prune -f

  # Phase 6: å“è³ªã‚²ãƒ¼ãƒˆ
  quality-gate:
    name: ğŸšª Quality Gate
    runs-on: ubuntu-latest
    needs: [security-scan, backend-quality, frontend-quality, docker-integration]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "ğŸ“Š Phase 1.5 å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯"

          # å¿…é ˆã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—"
            exit 1
          fi

          if [[ "${{ needs.backend-quality.result }}" != "success" ]]; then
            echo "âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—"
            exit 1
          fi

          if [[ "${{ needs.frontend-quality.result }}" != "success" ]]; then
            echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—"
            exit 1
          fi

          if [[ "${{ needs.docker-integration.result }}" != "success" ]]; then
            echo "âŒ Dockerçµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—"
            exit 1
          fi

          echo "âœ… Phase 1.5 å“è³ªã‚²ãƒ¼ãƒˆé€šé"
          echo "ğŸ¯ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†"

      - name: Generate summary report
        run: |
          echo "ğŸ“‹ Phase 1.5 CI/CD Summary"
          echo "=========================="
          echo "ğŸ›¡ï¸  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.security-scan.result }}"
          echo "ğŸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å“è³ª: ${{ needs.backend-quality.result }}"
          echo "âš›ï¸  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å“è³ª: ${{ needs.frontend-quality.result }}"
          echo "ğŸ³ Dockerçµ±åˆãƒ†ã‚¹ãƒˆ: ${{ needs.docker-integration.result }}"
          echo "=========================="
          echo "ğŸ‰ Phase 1.5 CI/CD Pipeline å®Œäº†"
