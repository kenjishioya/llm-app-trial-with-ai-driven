name: ğŸš€ Infrastructure CI/CD Pipeline

# Phase 0: Infrastructure ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä¸€æ™‚ç„¡åŠ¹åŒ–
# Phase 1 ä»¥é™ã§æœ‰åŠ¹åŒ–äºˆå®š
on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿è¨±å¯
  # push:
  #   branches: [main, develop]
  #   paths: ['infra/**', 'scripts/**', '.github/workflows/infrastructure.yml']
  # pull_request:
  #   branches: [main]
  #   paths: ['infra/**', 'scripts/**']

env:
  AZURE_RESOURCE_GROUP: qrai-rg-dev
  AZURE_LOCATION: japaneast

jobs:
  # Phase 0: æ§‹é€ æ¤œè¨¼ã®ã¿
  validate-infrastructure-structure:
    name: ğŸ“‹ Infrastructure Structure Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate infrastructure structure
        run: |
          echo "ğŸ” Phase 0 ã‚¤ãƒ³ãƒ•ãƒ©æ§‹é€ æ¤œè¨¼"

          # å¿…é ˆãƒ•ã‚©ãƒ«ãƒ€ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo "ğŸ“ ã‚¤ãƒ³ãƒ•ãƒ©ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          test -d infra/bicep && echo "âœ… infra/bicep/"
          test -d infra/terraform && echo "âœ… infra/terraform/"
          test -f infra/bicep/main.bicep && echo "âœ… infra/bicep/main.bicep"
          test -f infra/bicep/main.bicepparam && echo "âœ… infra/bicep/main.bicepparam"
          test -f infra/terraform/main.tf && echo "âœ… infra/terraform/main.tf"
          test -f infra/terraform/variables.tf && echo "âœ… infra/terraform/variables.tf"

          echo "âœ… Phase 0 ã‚¤ãƒ³ãƒ•ãƒ©æ§‹é€ æ¤œè¨¼å®Œäº†"
          echo "â„¹ï¸  å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯Phase 1ä»¥é™ã§å®Ÿè¡Œäºˆå®š"

  # Phase 0: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®ã¿ï¼ˆAzureèªè¨¼ä¸è¦ï¼‰
  security-scan:
    name: ğŸ›¡ï¸ Infrastructure Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Infrastructure Security Scan
        run: |
          echo "ğŸ” ã‚¤ãƒ³ãƒ•ãƒ©ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"

          # APIã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆ.tfã¨.bicepãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
          if grep -r --include="*.bicep" --include="*.tf" \
             'sk-[a-zA-Z0-9]\{20,\}\|AIza[a-zA-Z0-9]\{35\}' \
             --exclude-dir=.git .; then
            echo "âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸAPIã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šå³å¯†ã«ï¼‰
          if grep -r --include="*.bicep" --include="*.tf" \
             '[a-zA-Z0-9._%+-]\+@\(example\|test\|domain\)\.\(com\|org\|net\)' \
             --exclude-dir=.git .; then
            echo "âŒ ãƒ†ã‚¹ãƒˆç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          echo "âœ… ã‚¤ãƒ³ãƒ•ãƒ©ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

  # Phase 0: å“è³ªã‚²ãƒ¼ãƒˆ
  quality-gate:
    name: ğŸšª Infrastructure Quality Gate
    runs-on: ubuntu-latest
    needs: [validate-infrastructure-structure, security-scan]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "ğŸ“Š Phase 0 ã‚¤ãƒ³ãƒ•ãƒ©å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯"

          # å¿…é ˆã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          if [[ "${{ needs.validate-infrastructure-structure.result }}" != "success" ]]; then
            echo "âŒ ã‚¤ãƒ³ãƒ•ãƒ©æ§‹é€ æ¤œè¨¼å¤±æ•—"
            exit 1
          fi

          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "âŒ ã‚¤ãƒ³ãƒ•ãƒ©ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—"
            exit 1
          fi

          echo "âœ… Phase 0 ã‚¤ãƒ³ãƒ•ãƒ©å“è³ªã‚²ãƒ¼ãƒˆé€šé"
          echo "ğŸ¯ Phase 1 ã§Azureãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹äºˆå®š"
