name: ğŸš€ Infrastructure CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths: ['infra/**', 'scripts/**', '.github/workflows/infrastructure.yml']
  pull_request:
    branches: [main]
    paths: ['infra/**', 'scripts/**']

env:
  AZURE_RESOURCE_GROUP: qrai-rg-dev
  AZURE_LOCATION: japaneast

jobs:
  validate:
    name: ğŸ” Validate Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep Template
        run: |
          echo "ğŸ” Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æ–‡ãƒã‚§ãƒƒã‚¯"
          az bicep build --file infra/bicep/main.bicep --stdout > /dev/null
          echo "âœ… Bicepæ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Terraform Format Check
        run: |
          echo "ğŸ” Terraformãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯"
          cd infra/terraform
          terraform fmt -check -recursive
          echo "âœ… Terraformãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèªå®Œäº†"

      - name: Terraform Validate
        run: |
          echo "ğŸ” Terraformæ§‹æ–‡ãƒã‚§ãƒƒã‚¯"
          cd infra/terraform
          terraform init -backend=false
          terraform validate
          echo "âœ… Terraformæ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Bicep What-If Analysis
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ“Š Bicep What-Ifåˆ†æå®Ÿè¡Œ"
          USER_OBJECT_ID=$(az ad signed-in-user show --query id -o tsv)

          # ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          if ! az group show --name ${{ env.AZURE_RESOURCE_GROUP }} &>/dev/null; then
            az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location ${{ env.AZURE_LOCATION }}
          fi

          az deployment group what-if \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infra/bicep/main.bicep \
            --parameters @infra/bicep/main.bicepparam \
            --parameters keyVaultAccessObjectId=$USER_OBJECT_ID \
            --parameters openRouterApiKey='test-key-placeholder' \
            --parameters googleAiApiKey='test-key-placeholder'

  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Security Scan
        run: |
          echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"

          # APIã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
          if grep -r --include="*.bicep" --include="*.tf" --include="*.yml" --include="*.py" \
             'sk-[a-zA-Z0-9]\{20,\}\|AIza[a-zA-Z0-9]\{35\}' \
             --exclude-dir=.git --exclude-dir=node_modules .; then
            echo "âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸAPIã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
          if grep -r --include="*.bicep" --include="*.tf" --include="*.yml" \
             '[a-zA-Z0-9._%+-]\+@[a-zA-Z0-9.-]\+\.[a-zA-Z]\{2,\}' \
             --exclude-dir=.git .; then
            echo "âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

  deploy-bicep:
    name: ğŸš€ Deploy Bicep Infrastructure
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: github.ref == 'refs/heads/main'
    environment: development
    outputs:
      key-vault-name: ${{ steps.bicep-deploy.outputs.key-vault-name }}
      search-endpoint: ${{ steps.bicep-deploy.outputs.search-endpoint }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          if ! az group show --name ${{ env.AZURE_RESOURCE_GROUP }} &>/dev/null; then
            echo "ğŸ“¦ ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ: ${{ env.AZURE_RESOURCE_GROUP }}"
            az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location ${{ env.AZURE_LOCATION }}
          else
            echo "âœ… ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ç¢ºèªæ¸ˆã¿: ${{ env.AZURE_RESOURCE_GROUP }}"
          fi

      - name: Deploy Bicep Template
        id: bicep-deploy
        run: |
          echo "ğŸš€ Bicepãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé–‹å§‹"
          USER_OBJECT_ID=$(az ad signed-in-user show --query id -o tsv)
          DEPLOYMENT_NAME="qrai-bicep-$(date +%Y%m%d-%H%M%S)"

          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name $DEPLOYMENT_NAME \
            --template-file infra/bicep/main.bicep \
            --parameters @infra/bicep/main.bicepparam \
            --parameters keyVaultAccessObjectId=$USER_OBJECT_ID \
            --parameters openRouterApiKey='${{ secrets.OPENROUTER_API_KEY }}' \
            --parameters googleAiApiKey='${{ secrets.GOOGLE_AI_API_KEY }}' \
            --verbose

          # Outputså–å¾—
          KEY_VAULT_NAME=$(az deployment group show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.keyVaultName.value -o tsv)

          SEARCH_ENDPOINT=$(az deployment group show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.searchEndpoint.value -o tsv)

          echo "key-vault-name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT
          echo "search-endpoint=$SEARCH_ENDPOINT" >> $GITHUB_OUTPUT
          echo "âœ… Bicepãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: Key Vault=$KEY_VAULT_NAME"

  deploy-terraform:
    name: ğŸ—ï¸ Deploy Terraform Infrastructure
    runs-on: ubuntu-latest
    needs: [deploy-bicep]
    if: github.ref == 'refs/heads/main'
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Terraform Plan
        run: |
          echo "ğŸ“‹ Terraformãƒ—ãƒ©ãƒ³å®Ÿè¡Œ"
          cd infra/terraform
          terraform init
          terraform plan \
            -var="bicep_key_vault_name=${{ needs.deploy-bicep.outputs.key-vault-name }}" \
            -var="bicep_search_endpoint=${{ needs.deploy-bicep.outputs.search-endpoint }}" \
            -out=tfplan

      - name: Terraform Apply
        run: |
          echo "ğŸš€ Terraformãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ"
          cd infra/terraform
          terraform apply tfplan
          echo "âœ… Terraformãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

      - name: Display Deployment Summary
        run: |
          echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆçµæœã‚µãƒãƒªãƒ¼"
          echo "ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—: ${{ env.AZURE_RESOURCE_GROUP }}"
          echo "Key Vault: ${{ needs.deploy-bicep.outputs.key-vault-name }}"
          echo "Search Endpoint: ${{ needs.deploy-bicep.outputs.search-endpoint }}"
          echo "ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: Japan East"
