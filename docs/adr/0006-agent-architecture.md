# 0006 – Deep Research Agent にループベース設計採用

*Status*: **Accepted**
*Date*: 2025-06-03

## 背景

* 単純なRAG応答では満足できない複雑な質問（競合分析、市場調査など）に対応したい。
* ユーザーが「Deep Research」ボタンを押した場合は、多段階の調査プロセスを自動実行する。
* LLM自身にリサーチ計画を立てさせ、検索→要約→さらに検索のループで深掘りしたい。
* MVP範囲では複雑すぎず、実装・デバッグが容易なアーキテクチャを選択したい。

## 決定

* **Planner → Search → Summarizer → Writer のループベース設計**を採用。

  1. **Planner**: GPTに質問を分解させ、調査すべきサブトピックのリストを生成。
  2. **Search**: 各サブトピックでAI Searchを実行し、関連ドキュメントを収集。
  3. **Summarizer**: 収集したドキュメントから要点を抽出・要約。
  4. **Writer**: 全ての要約を統合し、構造化されたレポートを生成。

## 根拠・代替案

| 代替                        | 理由                     | 却下理由                                        |
| ------------------------- | ---------------------- | ------------------------------------------- |
| **LangGraph DAG**         | グラフベース、分岐・並列処理に強い    | MVP には複雑すぎ、デバッグが困難、学習コストが高い                |
| **Single-shot プロンプト**    | 実装が最もシンプル            | 長文生成で品質低下、引用管理が困難、トークン制限に引っかかりやすい       |
| **Agent Framework (AutoGEN)** | 複数エージェント対話で高品質     | 依存関係が重い、Azure OpenAI との統合が複雑、無料枠でのコスト心配 |
| **Retrieval Chain**       | LangChain標準パターン        | 検索→生成の1回のみ、Deep Researchの多段階要件に不適合    |

ループベース設計は**デバッグしやすく**、各ステップの中間結果を確認でき、問題箇所の特定が容易。

## 影響範囲

* **コンポーネント**: `DeepResearchAgent` クラスを新規作成。
* **データモデル**: `research_notes` テーブルでステップごとの中間結果を保存。
* **UI**: 進行状況表示（"Step 2/4: Searching for market data..."）。
* **パフォーマンス**: 複数回のLLM呼び出しで120秒以内の目標達成が必要。

## フォローアップ

* 各ステップの並列化可能性を検証（Search段階で複数クエリを同時実行）。
* ループ回数の上限設定（無限ループ防止）。
* 高品質なレポート生成のためのプロンプトエンジニアリング最適化。 